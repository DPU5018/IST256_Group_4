<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BillingDetails</title>
    <!--Credits: Nodejs/HTML: David Uhlmann Angular/CSS: Hamlet Baghdasaryan JavaScript/json/Jquery: Abel Chacko-->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- AngularJS (per assignment) | Author: Hamlet Baghdasaryan -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" type="text/css" href="Css.css">
</head>
<body ng-app="storeApp">
<header class="bg-primary text-white p-3">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">TBD Proto Corp</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Sign Up</a></li>
                    <li class="nav-item"><a class="nav-link" href="ShoppingCart.html">Cart</a></li>
                    <li class="nav-item"><a class="nav-link" href="ProductManagement.html">Product Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="Shipping.html">Shipping Info</a></li>
                    <li class="nav-item"><a class="nav-link active" href="BillingDetails.html">Billing Details</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container my-5" ng-controller="BillingCtrl as vm">
    <h2>Billing Details</h2>

    <!-- Purchase Receipt Table -->
    <div class="table-responsive my-4">
        <table class="table table-bordered table-striped" id="billingTable">
            <thead class="table-dark">
                <tr>
                    <th>Purchase Receipt</th>
                    <th>Date</th>
                    <th>Order Number</th>
                    <th>Shipping Address</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="order in vm.orders">
                  <td>{{order.receipt}}</td>
                  <td>{{order.date}}</td>
                  <td>{{order.orderNumber}}</td>
                  <td>{{order.shippingAddress}}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- JSON Display for debugging -->
    <h5>Billing Orders JSON:</h5>
    <pre id="billingJSON" class="bg-light p-3 border rounded">{{ vm.orders | json:2 }}</pre>
    <button class="btn btn-success mt-2" ng-click="vm.submit()">Submit Billing (AJAX)</button>
    <div id="ajaxStatus" class="mt-3" ng-if="vm.status.msg" ng-class="'alert alert-' + vm.status.kind">{{ vm.status.msg }}</div>
    <pre id="ajaxResponse" class="bg-light p-3 border rounded" ng-if="vm.server">{{ vm.server | json:2 }}</pre>

    <!-- Manage Previous Orders Card -->
    <div class="card p-3 mb-3">
        <h4>Manage Previous Orders</h4>
        <div class="mb-2">
            <label for="orderSearch" class="form-label">Tracking Current Orders:</label>
            <input type="text" class="form-control mb-2" placeholder="Enter Order Number" ng-model="vm.orderSearch">
            <button class="btn btn-primary" ng-click="vm.trackOrder()">Track Order</button>
        </div>
        <div>
            <a href="ItemsReturns.html" class="btn btn-warning">Return Items</a>
        </div>
    </div>
</main>

<script>
  (function(){
    'use strict';
    angular.module('storeApp', [])
      .controller('BillingCtrl', function($http){
        var vm = this;
        // Sample JSON document with products (moved from jQuery to Angular model)
        vm.orders = [
          {receipt: '001', date: '2025-11-10', orderNumber: 'A1001', shippingAddress: '123 Main St, City'},
          {receipt: '002', date: '2025-11-09', orderNumber: 'A1002', shippingAddress: '456 Oak Ave, Town'}
        ];

        vm.status = {kind:'', msg:''};
        vm.server = null;
        vm.orderSearch = '';

        vm.trackOrder = function(){
          var match = vm.orders.find(function(o){ return o.orderNumber === (vm.orderSearch||'').trim(); });
          if(match){
            alert('Order Found: ' + JSON.stringify(match, null, 2));
          } else {
            alert('Order not found');
          }
        };

        vm.submit = function(){
          vm.status = {kind:'info', msg:'Submitting billing details...'};
          vm.server = null;
            const express = require('express');
            const bodyParser = require('body-parser');
            const app = express();
            const server = require('http').Server(app);
            const port = 3004;
            const helmet = require('helmet');

            app.use(helmet());
            app.use(bodyParser.json());
            app.use(bodyParser.urlencoded({ extended: true }));

            app.use((req, res, next) => {
                res.setHeader('Access-Control-Allow-Origin', 'http://localhost:8080');
                res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');
                res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With, Content-Type, Accept');
                next();
            });

//pre-flight requests
            app.options('*', function(req, res) {
                res.send(200);
            });

            server.listen(port, (err) => {
                if (err) {
                    throw err;
                }
                /* eslint-disable no-console */
                console.log('Node Endpoints working :)');
            });

            module.exports = server;

          var endpoint = 'https://httpbin.org/post';
          $http.post(endpoint, vm.orders)
            .then(function(res){
              vm.status = {kind:'success', msg:'Billing submitted successfully.'};
              vm.server = res.data;
            })
            .catch(function(err){
              var msg = (err && err.data && (err.data.message||err.statusText)) || 'Request failed. Check API & CORS.';
              vm.status = {kind:'danger', msg: msg};
              vm.server = err && err.data ? err.data : err;
            });
        };
      });
  })();
  </script>

</body>
</html>
